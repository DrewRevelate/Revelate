<story-context id="bmad/bmm/workflows/4-implementation/story-context/1-5" v="2.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.5</storyId>
    <title>Test Coverage Reporting</title>
    <status>Drafted</status>
    <generatedAt>2025-10-30</generatedAt>
    <updatedAt>2025-10-30</updatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/story-1.5.md</sourceStoryPath>
    <projectRoot>/Users/drewlambert/Desktop/Revelate/revelateops-website</projectRoot>
  </metadata>

  <story>
    <asA>technical lead</asA>
    <iWant>automated test coverage reporting with visual indicators and CI enforcement</iWant>
    <soThat>I can track and maintain quality standards across the codebase</soThat>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1" status="PARTIALLY_COMPLETE">
      <description>Coverage Configuration Complete - Jest coverage thresholds set to 80% minimum with HTML and LCOV reporters enabled</description>
      <currentState>Thresholds configured (jest.config.js:41-56), but reporters not explicitly defined</currentState>
      <remainingWork>Add coverageReporters: ['text', 'html', 'lcov', 'text-summary'] to jest.config.js</remainingWork>
    </criterion>
    <criterion id="AC2" status="PARTIALLY_COMPLETE">
      <description>Reports Generated Automatically - npm run test:coverage generates text summary, HTML report, and lcov.info</description>
      <currentState>test:coverage script exists (package.json:12), default Jest reporters likely active</currentState>
      <remainingWork>Verify all reporter outputs, document report locations in README</remainingWork>
    </criterion>
    <criterion id="AC3" status="NOT_STARTED">
      <description>Coverage Badge Visible - README displays dynamic coverage badge linked to testing section</description>
      <currentState>README has testing section but no badge</currentState>
      <remainingWork>Add shields.io badge markdown to README top section, choose static vs dynamic approach</remainingWork>
    </criterion>
    <criterion id="AC4" status="NOT_STARTED">
      <description>CI/CD Enforcement Active - Vercel build fails if coverage drops below 80%</description>
      <currentState>No CI/CD integration found, Vercel uses standard 'npm run build' command</currentState>
      <remainingWork>Either modify build script or add GitHub Actions workflow to enforce coverage</remainingWork>
    </criterion>
    <criterion id="AC5" status="PARTIALLY_COMPLETE">
      <description>HTML Reports Accessible - Coverage HTML reports generated locally, browsable, gitignored</description>
      <currentState>.gitignore excludes /coverage (line 14), HTML reports likely generated by default</currentState>
      <remainingWork>Verify HTML generation, document viewing instructions in README</remainingWork>
    </criterion>
  </acceptanceCriteria>

  <constraints>
    <constraint id="C1">MUST maintain minimum 80% coverage threshold (branches, functions, lines, statements)</constraint>
    <constraint id="C2">MUST NOT break existing test infrastructure or passing tests</constraint>
    <constraint id="C3">MUST preserve special 90% threshold for lib/db/conversations.ts (jest.config.js:49-55)</constraint>
    <constraint id="C4">Coverage reports MUST be excluded from git (already in .gitignore)</constraint>
    <constraint id="C5">Solution MUST work with Next.js 16.0.0 App Router and Jest 30.2.0</constraint>
    <constraint id="C6">CI/CD integration MUST NOT significantly slow down Vercel deployments</constraint>
  </constraints>

  <existingArtifacts>
    <file path="jest.config.js" status="EXISTS" role="MODIFY">
      <description>Jest configuration with Next.js integration, coverage thresholds already set</description>
      <currentContent>
        <line range="1-6">Next.js Jest configuration wrapper (nextJest pattern)</line>
        <line range="10">testEnvironment: 'jest-environment-jsdom'</line>
        <line range="14">setupFilesAfterEnv: ['&lt;rootDir&gt;/__tests__/setup.ts']</line>
        <line range="17-19">moduleNameMapper for @/ path alias</line>
        <line range="22-25">testMatch patterns for .test.[jt]s?(x) files</line>
        <line range="28-38">collectCoverageFrom patterns (app/, components/, lib/, hooks/)</line>
        <line range="41-56">coverageThreshold: global 80%, conversations.ts 90%</line>
      </currentContent>
      <requiredChanges>
        <change>Add coverageReporters array after line 38: ['text', 'html', 'lcov', 'text-summary']</change>
        <change>Add coverageDirectory: 'coverage' if not implicit (verify current behavior)</change>
        <change>Verify reporters generate all expected outputs</change>
      </requiredChanges>
      <integrationNote>Uses createJestConfig wrapper for Next.js async config loading</integrationNote>
    </file>

    <file path="package.json" status="EXISTS" role="POTENTIALLY_MODIFY">
      <description>NPM package manifest with test scripts</description>
      <currentContent>
        <line range="10">test: "jest"</line>
        <line range="11">test:watch: "jest --watch"</line>
        <line range="12">test:coverage: "jest --coverage"</line>
        <line range="7">build: "next build" (may need coverage integration)</line>
      </currentContent>
      <requiredChanges>
        <change priority="HIGH">Option A: Change build to "next build &amp;&amp; npm run test:coverage"</change>
        <change priority="MEDIUM">Option B: Keep build unchanged, use GitHub Actions for coverage checks</change>
        <change priority="LOW">Add coverage:report script for opening HTML: "open coverage/index.html"</change>
      </requiredChanges>
      <dependencies>
        <dep>jest@30.2.0</dep>
        <dep>jest-environment-jsdom@30.2.0</dep>
        <dep>@testing-library/react@16.3.0</dep>
        <dep>@testing-library/jest-dom@6.9.1</dep>
        <dep>@testing-library/user-event@14.6.1</dep>
        <dep>ts-jest@29.4.5</dep>
      </dependencies>
    </file>

    <file path="README.md" status="EXISTS" role="MODIFY">
      <description>Project README with extensive testing documentation</description>
      <currentContent>
        <line range="1-9">Brand compliance header</line>
        <line range="11-27">Testing section with script documentation</line>
        <line range="28-39">Test file locations (__tests__/ structure)</line>
        <line range="41-89">Writing tests examples and patterns</line>
        <line range="90-96">Coverage thresholds documented (80%)</line>
        <line range="98-105">Test environment details</line>
      </currentContent>
      <requiredChanges>
        <change priority="HIGH" location="after-line-3">Add coverage badge: ![Coverage](https://img.shields.io/badge/coverage-XX%25-brightgreen)</change>
        <change priority="MEDIUM" location="testing-section">Add subsection "Viewing Coverage Reports" with instructions</change>
        <change priority="LOW" location="coverage-thresholds">Add note about CI/CD enforcement when implemented</change>
      </requiredChanges>
      <integrationNote>Badge should link to #testing section or coverage/index.html path</integrationNote>
    </file>

    <file path=".gitignore" status="EXISTS" role="VERIFIED">
      <description>Git ignore patterns, already excludes coverage</description>
      <currentContent>
        <line number="14">/coverage</line>
      </currentContent>
      <requiredChanges>
        <change>No changes needed - coverage directory already gitignored</change>
      </requiredChanges>
    </file>

    <directory path="__tests__" status="EXISTS" role="REFERENCE">
      <description>Test suite directory with setup and test files</description>
      <structure>
        <file>setup.ts - Global test configuration</file>
        <file>sample.test.ts - Example test</file>
        <dir>unit/ - Unit tests (db/conversations.test.ts)</dir>
        <dir>integration/ - API integration tests (contact, conversations, calendly, calcom, slack)</dir>
        <dir>e2e/ - Placeholder for end-to-end tests</dir>
      </structure>
      <integrationNote>All existing tests must continue passing after coverage reporter changes</integrationNote>
    </directory>

    <file path=".github/workflows/*.yml" status="NOT_EXISTS" role="OPTIONAL_CREATE">
      <description>GitHub Actions workflows for CI/CD (not currently present)</description>
      <optionalImplementation>
        <approach>Create .github/workflows/test-coverage.yml for PR coverage checks</approach>
        <triggers>on: [pull_request, push to main]</triggers>
        <steps>checkout, setup node, npm install, npm run test:coverage</steps>
        <enforcement>Job fails if Jest exits with non-zero (threshold violation)</enforcement>
      </optionalImplementation>
      <alternateApproach>Modify package.json build script to include coverage (simpler, but slower)</alternateApproach>
    </file>
  </existingArtifacts>

  <architecture>
    <component name="Jest Test Runner">
      <role>Executes tests and generates coverage data</role>
      <location>node_modules/.bin/jest</location>
      <configuration>jest.config.js via createJestConfig(customJestConfig)</configuration>
      <coverageFlow>
        <step>1. Jest instruments code using istanbul/babel</step>
        <step>2. Runs tests, tracking line/branch/function execution</step>
        <step>3. Compares coverage data against thresholds</step>
        <step>4. Generates reports via configured reporters</step>
        <step>5. Exits with code 1 if thresholds violated</step>
      </coverageFlow>
    </component>

    <component name="Coverage Reporters">
      <role>Transform coverage data into human/machine-readable formats</role>
      <reporters>
        <reporter name="text">Console output table, shown after test run</reporter>
        <reporter name="text-summary">Brief summary (1-2 lines)</reporter>
        <reporter name="html">Interactive HTML report in coverage/index.html</reporter>
        <reporter name="lcov">Machine-readable format (coverage/lcov.info) for CI/CD tools</reporter>
      </reporters>
      <outputLocation>coverage/ directory (configured via coverageDirectory)</outputLocation>
      <integrationNote>Reporters are plugins, must be implicitly or explicitly configured</integrationNote>
    </component>

    <component name="Next.js Jest Integration">
      <role>Provides Next.js-aware Jest configuration</role>
      <location>next/jest</location>
      <functionality>Loads next.config.js, handles CSS/image imports, configures transforms</functionality>
      <integrationPattern>const createJestConfig = nextJest({ dir: './' })</integrationPattern>
      <coverageImpact>Must ensure coverage works with Next.js module resolution and transforms</coverageImpact>
    </component>

    <component name="CI/CD Coverage Enforcement">
      <role>Prevent deployment if coverage drops below threshold</role>
      <currentState>Not implemented</currentState>
      <implementationOptions>
        <option id="1" complexity="LOW">
          <approach>Modify package.json build script</approach>
          <command>"build": "next build &amp;&amp; npm run test:coverage"</command>
          <pros>Simple, no additional files, immediate enforcement</pros>
          <cons>Slows every Vercel deployment, coverage runs on production builds</cons>
        </option>
        <option id="2" complexity="MEDIUM" recommended="true">
          <approach>GitHub Actions PR check workflow</approach>
          <file>.github/workflows/test-coverage.yml</file>
          <pros>Parallel execution, doesn't slow deployments, provides PR feedback</pros>
          <cons>Requires GitHub Actions setup, separate from Vercel</cons>
        </option>
        <option id="3" complexity="HIGH">
          <approach>Vercel deployment hooks + external service</approach>
          <description>Use Vercel pre-build hook to run tests before deployment</description>
          <pros>Integrated with Vercel, blocks deployment</pros>
          <cons>Complex setup, requires vercel.json configuration</cons>
        </option>
      </implementationOptions>
    </component>

    <component name="Coverage Badge">
      <role>Visual indicator of current test coverage in README</role>
      <currentState>Not implemented</currentState>
      <implementationOptions>
        <option id="1" complexity="LOW" recommended="FOR_MVP">
          <approach>Static shields.io badge</approach>
          <markdown>![Coverage](https://img.shields.io/badge/coverage-85%25-brightgreen)</markdown>
          <updateProcess>Manual update after running coverage</updateProcess>
          <pros>Simplest, no external dependencies</pros>
          <cons>Requires manual updates, can become stale</cons>
        </option>
        <option id="2" complexity="MEDIUM">
          <approach>Dynamic badge via GitHub Actions + Gist</approach>
          <workflow>GitHub Action updates JSON gist with coverage percentage</workflow>
          <markdown>![Coverage](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/...)</markdown>
          <pros>Auto-updates on every push, always accurate</pros>
          <cons>Requires GitHub Actions, gist creation, token management</cons>
        </option>
        <option id="3" complexity="HIGH">
          <approach>Third-party service (Coveralls, Codecov)</approach>
          <integration>Service generates and hosts badge</integration>
          <pros>Full featured, trend tracking, PR comments</pros>
          <cons>External dependency, requires account/token, overkill for simple needs</cons>
        </option>
      </implementationOptions>
    </component>
  </architecture>

  <implementationPatterns>
    <pattern name="Jest Coverage Configuration">
      <description>Standard Jest coverage setup for Next.js TypeScript projects</description>
      <code><![CDATA[
// jest.config.js
const customJestConfig = {
  // ... other config ...

  // Coverage reporters (MISSING - needs to be added)
  coverageReporters: ['text', 'html', 'lcov', 'text-summary'],

  // Coverage output directory (implicit default, can make explicit)
  coverageDirectory: 'coverage',

  // File patterns to collect coverage from
  collectCoverageFrom: [
    'app/**/*.{js,jsx,ts,tsx}',
    'components/**/*.{js,jsx,ts,tsx}',
    'lib/**/*.{js,jsx,ts,tsx}',
    'hooks/**/*.{js,jsx,ts,tsx}',
    '!**/*.d.ts',
    '!**/node_modules/**',
    '!**/.next/**',
    '!**/coverage/**',
    '!**/jest.config.js',
  ],

  // Coverage thresholds (already present)
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
};
]]></code>
      <testCommand>npm run test:coverage</testCommand>
      <expectedOutput>
        - Console: coverage table (text reporter)
        - File: coverage/index.html (html reporter)
        - File: coverage/lcov.info (lcov reporter)
        - Console: brief summary (text-summary reporter)
      </expectedOutput>
    </pattern>

    <pattern name="GitHub Actions Coverage Check">
      <description>PR workflow that enforces coverage thresholds</description>
      <code><![CDATA[
# .github/workflows/test-coverage.yml
name: Test Coverage

on:
  pull_request:
  push:
    branches: [main]

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run test:coverage
      # Job fails automatically if Jest exits non-zero (threshold violation)
]]></code>
      <integrationNote>This workflow runs in parallel with Vercel deployment, doesn't slow builds</integrationNote>
    </pattern>

    <pattern name="README Coverage Badge (Static)">
      <description>Simple static badge updated manually</description>
      <code><![CDATA[
# Revelate Operations - Brand Compliant Website

![Coverage](https://img.shields.io/badge/coverage-85%25-brightgreen)

Website score: 50/56 (Excellent - Brand Compliant)
]]></code>
      <updateProcess>
        1. Run: npm run test:coverage
        2. Note coverage percentage from output
        3. Update badge markdown: coverage-XX%25
        4. Choose color: red(&lt;60), yellow(60-79), green(80-89), brightgreen(90+)
      </updateProcess>
    </pattern>

    <pattern name="README Coverage Documentation">
      <description>Section explaining how to view and interpret coverage reports</description>
      <location>Add after line 96 in README.md (after coverage thresholds)</location>
      <code><![CDATA[
### Viewing Coverage Reports

After running `npm run test:coverage`, open the HTML report:

```bash
# Generate coverage report
npm run test:coverage

# Open HTML report in browser (macOS)
open coverage/index.html

# Or manually navigate to:
# revelateops-website/coverage/index.html
```

The coverage report shows:
- **Lines**: Percentage of code lines executed during tests
- **Branches**: Percentage of conditional branches taken (if/else, switch, etc.)
- **Functions**: Percentage of functions called during tests
- **Statements**: Percentage of statements executed

Click any file in the HTML report to see line-by-line coverage with highlighted uncovered code.
]]></code>
    </pattern>
  </implementationPatterns>

  <technicalDecisions>
    <decision id="TD1">
      <question>Which coverage reporters to enable?</question>
      <chosen>text, html, lcov, text-summary</chosen>
      <rationale>
        - text: Immediate feedback in console during development
        - html: Detailed browsable reports for deep investigation
        - lcov: Standard format for CI/CD tools and badge generation
        - text-summary: Quick overview without full table
      </rationale>
      <alternatives>
        <alt>json: Machine-readable but harder for humans</alt>
        <alt>cobertura: XML format, mainly for Java ecosystem</alt>
      </alternatives>
    </decision>

    <decision id="TD2">
      <question>How to enforce coverage in CI/CD?</question>
      <chosen>DEFERRED - Two options presented in story</chosen>
      <options>
        <opt priority="1">Modify build script (simple, immediate)</opt>
        <opt priority="2">GitHub Actions workflow (better, parallel)</opt>
      </options>
      <rationale>Let implementer choose based on deployment strategy preferences</rationale>
      <constraint>Must not break existing Vercel deployments if build modified</constraint>
    </decision>

    <decision id="TD3">
      <question>Static or dynamic coverage badge?</question>
      <chosen>Start with static, optionally upgrade to dynamic</chosen>
      <rationale>
        - Static is simplest MVP, no external dependencies
        - Dynamic requires GitHub Actions + gist setup (can add later)
        - Project appears to be early stage, manual updates acceptable initially
      </rationale>
      <upgradePath>Story 1.5 implements static, future story can add dynamic automation</upgradePath>
    </decision>

    <decision id="TD4">
      <question>Should coverage run on every build or only in CI?</question>
      <chosen>Test coverage script exists separately, build unmodified initially</chosen>
      <rationale>
        - Coverage is slow (~2-5x slower than regular tests)
        - Developers run test:coverage manually when needed
        - CI enforcement can be added without impacting dev workflow
      </rationale>
      <note>If build script modified for CI, document that local builds will be slower</note>
    </decision>
  </technicalDecisions>

  <integrationPoints>
    <integration name="Vercel Deployment">
      <current>Uses 'npm run build' command, no coverage enforcement</current>
      <proposedChange>Either modify build script or leave unchanged (use GitHub Actions instead)</proposedChange>
      <risk>If build modified, all deployments will run coverage (slower but safer)</risk>
    </integration>

    <integration name="Jest Test Suite">
      <current>Tests pass, coverage thresholds defined, test:coverage script works</current>
      <proposedChange>Add coverageReporters array to jest.config.js</proposedChange>
      <risk>LOW - reporters are additive, shouldn't break existing tests</risk>
    </integration>

    <integration name="README Documentation">
      <current>Extensive testing documentation, no coverage badge or report viewing instructions</current>
      <proposedChange>Add badge to top, add "Viewing Coverage Reports" section</proposedChange>
      <risk>NONE - documentation changes only</risk>
    </integration>

    <integration name="GitHub Repository">
      <current>No GitHub Actions workflows present</current>
      <proposedChange>Optionally add .github/workflows/test-coverage.yml</proposedChange>
      <risk>NONE if not implemented, LOW if implemented (new workflow, doesn't affect existing processes)</risk>
    </integration>
  </integrationPoints>

  <testingStrategy>
    <preImplementationTests>
      <test>Run npm run test:coverage and verify current output</test>
      <test>Check if coverage/ directory is generated</test>
      <test>Verify .gitignore excludes coverage</test>
      <test>Confirm all existing tests pass</test>
    </preImplementationTests>

    <postImplementationTests>
      <test>Run npm run test:coverage, verify all 4 reporters generate output</test>
      <test>Open coverage/index.html in browser, verify it displays coverage data</test>
      <test>Verify coverage/lcov.info file exists and contains data</test>
      <test>Check that console shows text and text-summary output</test>
      <test>Verify README badge is visible (inspect markdown rendering)</test>
      <test>If CI/CD modified: trigger deployment and verify coverage runs</test>
      <test>Test threshold enforcement: temporarily lower a score, verify failure</test>
    </postImplementationTests>

    <acceptanceValidation>
      <ac id="AC1">jest.config.js contains coverageReporters array with 4 reporters</ac>
      <ac id="AC2">npm run test:coverage generates coverage/, includes html and lcov files</ac>
      <ac id="AC3">README.md has coverage badge markdown near top of file</ac>
      <ac id="AC4">Either build script modified OR GitHub Actions workflow added that runs coverage</ac>
      <ac id="AC5">README documents how to view HTML reports, coverage/index.html is accessible</ac>
    </acceptanceValidation>
  </testingStrategy>

  <rollbackPlan>
    <step>If reporters break tests: remove coverageReporters array from jest.config.js</step>
    <step>If build script change breaks Vercel: revert package.json build command</step>
    <step>If GitHub Actions fails: delete or disable .github/workflows/test-coverage.yml</step>
    <step>README and badge changes are safe and don't require rollback</step>
  </rollbackPlan>

  <references>
    <ref type="internal" path="../revelateops-website/jest.config.js">Current Jest configuration</ref>
    <ref type="internal" path="../revelateops-website/package.json">NPM scripts and dependencies</ref>
    <ref type="internal" path="../revelateops-website/README.md">Project documentation</ref>
    <ref type="internal" path="../revelateops-website/__tests__">Test suite directory</ref>
    <ref type="external" url="https://jestjs.io/docs/configuration#coveragereporters-arraystring--string-options">Jest Coverage Reporters Docs</ref>
    <ref type="external" url="https://shields.io/badges">Shields.io Badge Generator</ref>
    <ref type="external" url="https://istanbul.js.org/docs/advanced/alternative-reporters/">Istanbul Coverage Reporters</ref>
  </references>
</story-context>
