<story-context id="bmad/bmm/workflows/4-implementation/story-context/1-3" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.3</storyId>
    <title>Integration Tests for API Endpoints</title>
    <status>Drafted</status>
    <generatedAt>2025-10-30</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/story-1.3.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>integration tests for all 10 API endpoints</iWant>
    <soThat>API contracts remain stable and reliable</soThat>
    <tasks>
      - Set up integration test infrastructure with Next.js request mocking
      - Test Contact & Chat endpoints (2 endpoints)
      - Test Calendly endpoints (4 endpoints)
      - Test Cal.com endpoints (3 endpoints)
      - Test Slack webhook endpoint (1 endpoint)
      - Mock all external API calls (Slack, Calendly, Cal.com)
      - Verify database state changes
      - Cover all success and error scenarios
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">Tests for Contact & Chat endpoints (2 endpoints)</criterion>
    <criterion id="AC2">Tests for Calendly endpoints (4 endpoints)</criterion>
    <criterion id="AC3">Tests for Cal.com endpoints (3 endpoints)</criterion>
    <criterion id="AC4">Tests for Slack webhook endpoint (1 endpoint)</criterion>
    <criterion id="AC5">Mock external API calls (Slack, Calendly, Cal.com)</criterion>
    <criterion id="AC6">Test database state changes</criterion>
    <criterion id="AC7">All success and error scenarios covered</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Integration Test Structure</title>
        <section>Testing Patterns</section>
        <snippet>Integration tests import Next.js route handlers directly, create NextRequest objects, call handlers, and assert on NextResponse. Mock external APIs to avoid hitting real services.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>revelateops-website/app/api/contact/route.ts</path>
        <kind>api-route</kind>
        <symbol>POST</symbol>
        <lines>N/A</lines>
        <reason>Contact form endpoint - creates conversation, sends Slack notification</reason>
      </file>
      <file>
        <path>revelateops-website/app/api/conversations/[id]/messages/route.ts</path>
        <kind>api-route</kind>
        <symbol>GET, POST</symbol>
        <lines>N/A</lines>
        <reason>Message retrieval and creation endpoints</reason>
      </file>
      <file>
        <path>revelateops-website/app/api/calendly/</path>
        <kind>api-routes</kind>
        <symbol>4 routes: availability, event-types, scheduling-link, user</symbol>
        <lines>N/A</lines>
        <reason>Calendly integration endpoints</reason>
      </file>
      <file>
        <path>revelateops-website/app/api/calcom/</path>
        <kind>api-routes</kind>
        <symbol>3 routes: availability, booking, test</symbol>
        <lines>N/A</lines>
        <reason>Cal.com integration endpoints</reason>
      </file>
      <file>
        <path>revelateops-website/app/api/slack/events/route.ts</path>
        <kind>api-route</kind>
        <symbol>POST</symbol>
        <lines>N/A</lines>
        <reason>Slack webhook endpoint with signature validation</reason>
      </file>
    </code>

    <dependencies>
      <current>
        <node>
          <dependencies>
            - next: 16.0.0 (NextRequest/NextResponse for API testing)
          </dependencies>
          <devDependencies>
            - jest: 30.2.0 (from Story 1.1)
          </devDependencies>
        </node>
      </current>
      <toInstall>
        <node>
          <devDependencies>
            - None required - use Jest mocking for external APIs
          </devDependencies>
        </node>
      </toInstall>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint id="C1">Must test all 10 API endpoints (2 contact/chat, 4 Calendly, 3 Cal.com, 1 Slack)</constraint>
    <constraint id="C2">Must mock external APIs (@slack/web-api, Calendly, Cal.com) to avoid real API calls</constraint>
    <constraint id="C3">Test file location: __tests__/integration/api/</constraint>
    <constraint id="C4">Must verify database state changes after API calls</constraint>
    <constraint id="C5">Must test all HTTP status codes: 200/201, 400, 401, 404, 500</constraint>
    <constraint id="C6">Must test both success and error paths for each endpoint</constraint>
    <constraint id="C7">Prerequisites: Story 1.1 (Jest) and Story 1.2 (DB patterns) must be complete</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /api/contact</name>
      <kind>API endpoint</kind>
      <signature>POST with body: { name, email, phone, company?, message }</signature>
      <path>revelateops-website/app/api/contact/route.ts</path>
      <reason>Creates conversation and sends Slack notification</reason>
    </interface>
    <interface>
      <name>GET/POST /api/conversations/[id]/messages</name>
      <kind>API endpoint</kind>
      <signature>GET returns messages[], POST with body: { sender, message_text }</signature>
      <path>revelateops-website/app/api/conversations/[id]/messages/route.ts</path>
      <reason>Message retrieval and creation</reason>
    </interface>
  </interfaces>

  <tests>
    <standards>
      <![CDATA[
        Testing framework: Jest 30.2.0 (from Story 1.1)
        Test location: __tests__/integration/api/
        Mocking: Jest mocks for @slack/web-api and external API clients
        Database: Same strategy as Story 1.2 (mock or test instance)
        Request creation: Use NextRequest from next/server
        Response assertions: status, json(), headers
        Coverage: All endpoints, all status codes, all error paths
      ]]>
    </standards>

    <locations>
      __tests__/integration/api/contact.test.ts
      __tests__/integration/api/conversations.test.ts
      __tests__/integration/api/calendly/*.test.ts (4 files)
      __tests__/integration/api/calcom/*.test.ts (3 files)
      __tests__/integration/api/slack/events.test.ts
      __tests__/integration/api/test-helpers.ts
    </locations>

    <ideas>
      <test ac="AC1,AC5,AC6,AC7" priority="critical">
        Test POST /api/contact success flow:
        - Create NextRequest with valid contact form data
        - Mock Slack client postMessage
        - Mock database createConversation
        - Call POST handler
        - Assert response status 201
        - Assert conversation created in database
        - Assert Slack notification sent with correct data
      </test>

      <test ac="AC5" priority="critical">
        Set up external API mocks:
        - Mock @slack/web-api WebClient
        - Mock Calendly API calls (fetch or SDK)
        - Mock Cal.com API calls
        - Create mock factories for common responses
        - Verify mocks are called with correct parameters
      </test>

      <test ac="AC7" priority="high">
        Test error scenarios for all endpoints:
        - 400 for invalid/missing request data
        - 401 for missing/invalid auth credentials
        - 404 for non-existent resources
        - 500 for external API failures
        - 500 for database connection errors
      </test>
    </ideas>
  </tests>
</story-context>
